LET vStartDate = Date(YearStart(Today()), 'YYYYMMDD');
LET vEndDate   = Date(YearEnd(Today()), 'YYYYMMDD');

// 1) Tüm veriyi alıyoruz (TK dahil)
KONTROLAKARAOGLAN_TEMP:
LOAD
    BELNR AS BELGE_NO,
    BUKRS AS SIRKET_KODU,
    GJAHR AS YIL,
    BLDAT,
    BUDAT,
    BLART AS BELGE_TURU,
    USNAM AS OLUSTURAN_KULLANICI,
    TCODE AS TRANSAKSIYON_KODU,
    AEDAT AS DEGISIKLIK_TARIHI,
    XBLNR AS REFERANS,
    STBLG AS TERSBELGENO,
    CPUDT AS ISLEM_TARIHI
WHERE
    BLDAT <> BUDAT
;
SQL SELECT
    BELNR,
    BUKRS,
    GJAHR,
    BLDAT,
    BLART,
    USNAM,
    TCODE,
    AEDAT,
    XBLNR,
    STBLG,
    CPUDT,
    BUDAT
FROM BKPF
WHERE USNAM IN (
    'AKARAOGLAN', 'NZAMBAK', 'KCELEBI', 'MSERDAR',
    'SPERKKARA', 'MGUL', 'ISOZER', 'GATILGAN',
    'IBABA', 'HANDAN', 'CERDOGAN', 'SCELIK', 'NDEMIREL', 'SEMRE', 'ASEVINC', 'FALTINDAG', 'AKABADAYI', 'FGULGAR', 'MYAMAN'
)
AND BUKRS = '2000'
AND BLDAT BETWEEN '$(vStartDate)' AND '$(vEndDate)'
AND TCODE NOT IN (
    'KO88', 'ZCO011', 'ZCO007R1', 'MR21', 'AFABN', 'KSS2', 'KSII',
    'KON2', 'KO8G', 'KKAO', 'CO88H', 'MR11', 'KSV5', 'KSU5',
    'KE27', 'KEU5', 'CJ88', 'CJ8G', 'AFAB', 'KOC4', '/MBIS/ENF_P006', 'CK24'
)
AND TCODE IS NOT NULL
AND TCODE <> ''
AND BLART NOT IN ('XX', 'FX')
AND (
    STBLG IS NULL
    OR STBLG = ''
)
;

// 2) 'TK' olanların Referanslarını (XBLNR) alıyoruz - hariç tutulacaklar listesi
TK_REFERANSLAR:
LOAD DISTINCT
    REFERANS AS EXCLUDE_REF
RESIDENT KONTROLAKARAOGLAN_TEMP
WHERE BELGE_TURU = 'TK'
;

// 3) Sonuç tablosunu oluşturuyoruz - 'TK' ler ve aynı referanslılar çıkıyor
KONTROLAKARAOGLAN_FINAL:
LOAD
    BELGE_NO,
    SIRKET_KODU,
    YIL,
    Date(BLDAT, 'DD.MM.YYYY') AS BELGE_TARIHI,
    Date(BUDAT, 'DD.MM.YYYY') AS KAYITTARIH,
    BELGE_TURU,
    OLUSTURAN_KULLANICI,
    TRANSAKSIYON_KODU,
    DEGISIKLIK_TARIHI,
    REFERANS,
    TERSBELGENO,
    ISLEM_TARIHI
RESIDENT KONTROLAKARAOGLAN_TEMP
WHERE BELGE_TURU <> 'TK'
  AND NOT Exists(EXCLUDE_REF, REFERANS)
;

// 4) Geçici tabloları siliyoruz
DROP TABLE KONTROLAKARAOGLAN_TEMP;
DROP TABLE TK_REFERANSLAR;
